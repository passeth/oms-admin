# Supabase OMS 시스템 아키텍처 및 프론트엔드 로드맵

## 1. 데이터베이스 구조 정의 (Data Dictionary)

이미지를 통해 확인된 최종 테이블 목록입니다. 각 테이블의 주인(Owner)과 역할을 명확히 합니다.

### A. 마스터 데이터 (기준 정보)

| 테이블명 | 한글명 | 역할 및 정의 | 관리 주체 | 핵심 컬럼 |
| :--- | :--- | :--- | :--- | :--- |
| **`cm_erp_products`** | ERP 상품 마스터 | 회사의 모든 단품(SKU) 정보. | ERP 관리자 | `product_id`, `name` |
| **`cm_kit_bom_items`** | 키트 구성품(BOM) | "이 세트는 이 단품들로 구성됨" 정의. | MD | `kit_id`, `product_id`, `quantity` |
| **`cm_raw_mapping_rules`** | 주문 매칭 규칙 | "이 옵션명은 이 키트다" 매핑 사전. (가장 중요) | MD / 배송팀 | `raw_identifier` (옵션명), `kit_id` |
| **`cm_promo_rules`** | 행사 규칙 | "이 기간, 이 상품을 N개 사면 준다" 정의. | MD | `promo_group_id`, `target_kit_id`, `promo_type`, `condition_qty` |
| **`cm_sales_platforms`** | 판매처 코드 | (참조용) 쿠팡, G마켓 등 플랫폼 코드. | MD | `platform_name` |

### B. 트랜잭션 데이터 (매일 쌓이는 것)

| 테이블명 | 한글명 | 역할 및 정의 | 생성 시점 | 핵심 컬럼 |
| :--- | :--- | :--- | :--- | :--- |
| **`cm_raw_order_lines`** | 주문 원장 | 업로드된 모든 주문 내역(원본+사은품). | 매일 아침 (업로드) | `site_order_no`, `process_status` (NULL/GIFT_APPLIED/DONE) |
| **`cm_order_gifts`** | 사은품 지급 내역 | 사은품 지급의 근거(어떤 원본 주문들 -> 어떤 사은품 주문) 연결. | 오후 (사은품 지정 시) | `generated_order_id` (사은품 주문ID), `source_order_ids` (원본 주문ID들) |

### C. 뷰 (View) - 프론트엔드가 바라볼 화면

| 뷰 이름 | 프론트엔드 화면 | 용도 |
| :--- | :--- | :--- |
| **`cm_view_latest_batch_result`** | [결과 다운로드] | 최종 배송 리스트 (본품 + BOM 전개 + 사은품 포함). |
| **`cm_view_unmatched_orders`** | [숙제장 A] | 룰이 없어서 매칭 실패한 주문만 모아보기. |
| **`cm_view_missing_bom_summary`** | [숙제장 B] | 매칭은 됐는데, BOM(구성품)이 정의 안 된 키트. |
| **`cm_view_promo_targets_pending`** | [사은품 지정] | 행사 조건은 맞는데, 아직 사은품 안정해진 주문들. |

---

## 2. 업무 플로우 (Daily Routine)

프론트엔드 화면은 이 순서대로 개발되어야 합니다.

### [Step 1] 주문 취합 및 업로드

1. 사용자가 엑셀 파일(들)을 드래그 & 드롭.
2. **Next.js:** 파일을 파싱하여 `cm_raw_order_lines`에 `INSERT`.
3. **DB(Trigger):** 들어오자마자 `fn_match_order_kits()` 실행 -> `matched_kit_id` 자동 채움.

### [Step 2] 예외 처리 ("숙제 검사") - **가장 중요한 효율화 포인트**

1. **화면:** "미매칭 주문(숙제장)" 대시보드 진입.
2. **상황:** "옵션명: `[특가] 로즈마인 5종`" 이라는 처음 보는 주문 등장.
3. **Action (효율화 방안):**
    * **Bad:** 일일이 Kit ID 타자 쳐서 입력하기. (오타 발생, 느림)
    * **Good (제안):**
        * 화면 왼쪽: 미매칭 옵션명 리스트
        * 화면 오른쪽: **[Kit 검색기]** + **[유사어 추천]**
        * 사용자가 `로즈마인` 검색 -> 기존 Kit 목록 뜸 -> 클릭 -> **[이걸로 매핑 등록]** 버튼 꾹.
        * -> `cm_raw_mapping_rules`에 저장됨 -> **[재매칭]** 버튼 누르면 해당 주문들 싹 사라짐(해결).

### [Step 3] 사은품 지정

1. **화면:** "사은품 지정 대시보드" 진입.
2. **상황:** "오늘 GS 로즈마인 행사 대상자 50명 대기 중" 배지 알림.
3. **Action:**
    * 담당자가 [GS 로즈마인] 카드 클릭.
    * "현재 재고 넉넉한 [핸드크림 A]로 주자." 선택.
    * [50명 일괄 적용] 버튼 클릭.
    * **결과:**
        * `cm_order_gifts` 테이블에 이력 생성.
        * `cm_raw_order_lines`에 **새로운 사은품 주문** 50건 생성 (`process_status`는 `NULL`).
        * 원본 주문 50건의 `process_status`는 `GIFT_APPLIED`로 변경 (중복 지급 방지).

### [Step 4] 최종 다운로드 및 출고 (Dispatch)

1. **화면:** "출고 센터 / Today's Dispatch".
2. **조건:** **Today's Upload** 기준, 상태가 **DONE(완료)**인 주문만 집계.
    * 원본 주문은 사은품 적용 후 상태가 `GIFT_APPLIED` -> 이후 다운로드하여 송장 처리 시 `DONE`이 될 수 있음.
    * 사은품 주문은 생성 직후 `NULL` -> 다운로드하여 처리 시 `DONE`이 됨.
3. **Action:**
    * [Picking List Excel]: 창고지기에게 전달할 상품 합계 리스트.
    * [Ecount Upload Excel]: 이카운트에 업로드할 판매/출고 전표 양식.

---

## 3. 프론트엔드 개발 로드맵 (Next.js)

### 1단계: 프로젝트 세팅 (내일 바로 시작)

* `npx create-next-app`

* ShadcnUI (디자인 라이브러리) 설치 : **"이쁘고 세련된 대시보드"**를 위해 필수.
* Supabase Client 연결.

### 2단계: 필수 화면 ("숙제장" 부터)

사용자님이 가장 고통스러워하는 **"Missing Rules 입력"** 화면부터 만듭니다.

* **UI:** 엑셀 같은 테이블(Ag-Grid 추천) + 우측에 'Kit 검색/할당' 패널.
* **기능:** 체크박스 다중 선택 -> 일괄 룰 등록.

### 3단계: 프로모션 관리자

* MD가 "복붙"으로 행사를 등록하는 화면.

* 배송팀이 사은품을 "일괄 지정"하는 화면.

### 4단계: 대시보드 & 시각화

* "오늘 주문 3,000건, 처리율 98%, 미처리 2%" 같은 멋진 그래프.

---

## 4. 사용자 질문 답변: "입력 효율화 방법은?"

**Q. Missing Rule/BOM 입력 너무 번거로울 것 같은데?**
**A. 프론트엔드에서 아래 3가지 기능으로 해결합니다.**

1. **일괄 등록 (Bulk Action):**
    * 같은 옵션명의 주문이 100개 들어와도, 룰은 **딱 1번만** 등록하면 100개가 동시에 해결됩니다.
    * 프론트엔드에서 `cm_view_missing_rules_summary` (요약본)를 보여주므로, 하루에 처리할 양은 주문 수(20만 건)가 아니라 **"신규 옵션 종류(10~20건)"** 뿐입니다.
2. **자동완성/검색 (Search):**
    * Kit ID를 칠 필요 없이, `로즈`만 쳐도 `ROSE_SET_01`, `ROSE_BODY`... 목록이 나와서 클릭만 하면 됩니다.
3. **최근 매핑 복사:**
    * "어? 이거 저번 그 행사 상품이랑 같은 건데?" -> [최근 등록 내역 불러오기] 기능.

이제 "입력"의 고통은 사라지고, **"클릭"의 즐거움**만 남을 것입니다. 🚀
